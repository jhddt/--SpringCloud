# 选课服务404问题排查

## 问题描述
学生端无法查询可选课程信息，出现404错误：
```
GET http://localhost:3002/api/selection/available?current=1&size=10&keyword=&studentId=7 404 (Not Found)
```

## 已完成的代码修改

### 1. 后端代码（selection-service）

#### 1.1 控制器端点
- ✅ 已添加 `/selection/available` 端点
- ✅ `studentId` 参数已设置为可选（`required = false`）
- ✅ 端点路径：`GET /selection/available`

#### 1.2 服务层逻辑
- ✅ 实现了 `getAvailableCourses` 方法
- ✅ 支持分批获取所有开放选课的课程
- ✅ 实现了过滤逻辑：
  - 排除已选课程（如果studentId不为空）
  - 容量检查
  - 时间冲突检查（如果studentId不为空）
  - 专业匹配（目前未严格限制）
- ✅ 实现了手动分页（基于过滤后的结果）
- ✅ 支持 `studentId` 为 null 的情况（允许未登录用户查看课程）

#### 1.3 Feign客户端
- ✅ `CourseServiceClient` 已配置
- ✅ `StudentServiceClient` 已配置
- ✅ `MessageServiceClient` 已配置

#### 1.4 配置
- ✅ `@EnableFeignClients` 已添加
- ✅ `spring-cloud-starter-openfeign` 依赖已添加
- ✅ `spring-cloud-starter-loadbalancer` 依赖已添加
- ✅ Nacos服务发现已配置
- ✅ 服务名称：`selection-service`

### 2. 网关配置（gateway）

- ✅ 路由配置正确：
  ```yaml
  - id: selection-service
    uri: lb://selection-service
    predicates:
      - Path=/api/selection/**
    filters:
      - StripPrefix=1
  ```
- ✅ 服务发现已启用
- ✅ 路由前缀剥离已配置

### 3. 前端代码（frontend-student）

- ✅ `CourseBrowse.vue` 已更新
- ✅ 使用新的 `/selection/available` 接口
- ✅ `studentId` 参数条件性传递
- ✅ 错误处理已完善

## 可能的原因

### 1. 服务未运行
- selection-service 可能没有启动
- 检查端口 8086 是否被占用

### 2. 服务未注册到Nacos
- selection-service 可能没有成功注册到 Nacos
- 检查 Nacos 控制台（http://localhost:8848/nacos）中是否有 `selection-service` 服务

### 3. 代码未重新编译
- 如果服务正在运行，可能需要重新编译和重启
- Maven 项目需要重新构建

### 4. 网关无法发现服务
- 网关可能无法从 Nacos 发现 selection-service
- 检查网关日志是否有服务发现错误

## 排查步骤

### 步骤1：检查服务是否运行
```bash
# Windows PowerShell
netstat -ano | findstr :8086

# 应该看到类似输出：
# TCP    0.0.0.0:8086           0.0.0.0:0              LISTENING       38152
```

### 步骤2：检查Nacos服务注册
1. 打开 Nacos 控制台：http://localhost:8848/nacos
2. 登录（默认用户名/密码：nacos/nacos）
3. 进入「服务管理」->「服务列表」
4. 查看是否有 `selection-service` 服务
5. 检查服务状态是否为「健康」

### 步骤3：检查网关日志
查看网关服务的日志，查找：
- 服务发现相关的错误
- 路由匹配相关的日志
- 404错误的具体原因

### 步骤4：重新编译和重启服务

#### 4.1 重新编译 selection-service
```bash
cd selection-service
mvn clean compile
```

#### 4.2 重启 selection-service
1. 停止当前运行的 selection-service
2. 重新启动 selection-service
3. 等待服务完全启动（查看启动日志）

#### 4.3 重启网关（如果需要）
1. 停止网关服务
2. 重新启动网关服务
3. 等待服务完全启动

### 步骤5：测试端点

#### 5.1 直接测试 selection-service
```bash
# 使用curl测试（需要有效的token）
curl -X GET "http://localhost:8086/selection/available?current=1&size=10" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 5.2 通过网关测试
```bash
# 通过网关测试（需要有效的token）
curl -X GET "http://localhost:8888/api/selection/available?current=1&size=10&studentId=7" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 解决方案

### 方案1：重启服务（推荐）
1. 停止 selection-service
2. 重新编译项目：`mvn clean package`
3. 重新启动 selection-service
4. 检查服务是否成功注册到 Nacos
5. 测试端点是否可用

### 方案2：检查服务配置
1. 确认 `application.yml` 中的服务名称是 `selection-service`
2. 确认 Nacos 地址配置正确：`localhost:8848`
3. 确认服务端口是 `8086`

### 方案3：检查网络连接
1. 确认 selection-service 可以连接到 Nacos
2. 确认网关可以连接到 Nacos
3. 确认前端可以连接到网关

## 验证步骤

### 1. 检查服务注册
- [ ] selection-service 在 Nacos 中可见
- [ ] 服务状态为「健康」
- [ ] 服务实例数量 > 0

### 2. 检查网关路由
- [ ] 网关可以访问 Nacos
- [ ] 网关可以发现 selection-service
- [ ] 路由配置正确

### 3. 测试端点
- [ ] 直接访问 selection-service 端点成功
- [ ] 通过网关访问端点成功
- [ ] 前端可以正常调用接口

## 常见问题

### Q1: 服务启动后立即退出
**A:** 检查：
- 数据库连接是否正常
- Redis连接是否正常
- Nacos连接是否正常
- 端口是否被占用

### Q2: 服务注册成功但网关无法发现
**A:** 检查：
- 网关和服务是否使用相同的 Nacos 命名空间
- 网关的服务发现配置是否正确
- 网关是否已重启

### Q3: 端点返回404但服务正常运行
**A:** 检查：
- 控制器路径是否正确
- 请求路径是否匹配
- 网关路由配置是否正确
- StripPrefix 配置是否正确

## 下一步

1. 按照排查步骤逐一检查
2. 重新编译和重启服务
3. 验证服务注册和路由配置
4. 测试端点是否可用
5. 如果问题仍然存在，查看详细的错误日志

## 相关文件

- `selection-service/src/main/java/com/education/selection/controller/SelectionController.java`
- `selection-service/src/main/java/com/education/selection/service/SelectionService.java`
- `selection-service/src/main/resources/application.yml`
- `gateway/src/main/resources/application.yml`
- `frontend-student/src/views/CourseBrowse.vue`

